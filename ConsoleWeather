using System;
using System.Net.Http;
using System.Net.Http.Json; // Потрібен для GetFromJsonAsync
using System.Text.Json.Serialization; // Потрібен для JsonPropertyName
using System.Threading.Tasks;

// ====================================================================
// МОДЕЛІ ДЛЯ ДЕСЕРІАЛІЗАЦІЇ JSON
// Класи, що відображають структуру відповіді OpenWeather API
// ====================================================================

// Головна модель відповіді
public class OpenWeatherResponse
{
    // Використовуємо атрибут, щоб зіставити властивість "main" з JSON-полем
    [JsonPropertyName("main")]
    public Main MainInfo { get; set; }

    // Масив об'єктів погоди (опис, іконка)
    [JsonPropertyName("weather")]
    public Weather[] Weather { get; set; }

    // Назва міста, повернута API
    [JsonPropertyName("name")]
    public string CityName { get; set; }

    // Код відповіді API (200, 404 тощо). Відрізняється від HTTP Status Code.
    [JsonPropertyName("cod")]
    public int Cod { get; set; }
}

// Модель для секції "main" (температура, вологість)
public class Main
{
    [JsonPropertyName("temp")]
    public double Temperature { get; set; }

    [JsonPropertyName("feels_like")]
    public double FeelsLike { get; set; }

    [JsonPropertyName("humidity")]
    public int Humidity { get; set; }
}

// Модель для об'єкта "weather" (опис погоди)
public class Weather
{
    [JsonPropertyName("description")]
    public string Description { get; set; }
}


// ====================================================================
// ОСНОВНА ЛОГІКА ПРОГРАМИ
// ====================================================================

class WeatherApp
{
    // Оскільки HttpClient слід створювати лише один раз і перевикористовувати, 
    // використовуємо статичне поле.
    private static readonly HttpClient httpClient = new HttpClient();

    // !!! ВАШ КЛЮЧ API !!! 
    // Замініть цей рядок на ваш реальний ключ OpenWeatherMap.
    private const string API_KEY = "YOUR_API_KEY"; 

    static async Task Main(string[] args)
    {
        Console.OutputEncoding = System.Text.Encoding.UTF8;
        Console.WriteLine("--- Консольний Застосунок Погоди OpenWeather ---");

        if (API_KEY == "YOUR_API_KEY")
        {
            Console.ForegroundColor = ConsoleColor.Red;
            Console.WriteLine("\n[ПОМИЛКА НАЛАШТУВАННЯ]: Будь ласка, замініть 'YOUR_API_KEY' на ваш ключ OpenWeatherMap.");
            Console.ResetColor();
            Console.ReadKey();
            return;
        }

        Console.Write("Введіть назву міста (наприклад, Kyiv, London): ");
        string city = Console.ReadLine()?.Trim();

        if (string.IsNullOrWhiteSpace(city))
        {
            Console.WriteLine("Назва міста не може бути порожньою.");
            return;
        }

        // Запускаємо асинхронну функцію для отримання погоди
        await GetWeatherForCity(city);

        Console.WriteLine("\nНатисніть будь-яку клавішу для виходу...");
        Console.ReadKey();
    }

    /// <summary>
    /// Асинхронно отримує дані про погоду для вказаного міста та обробляє можливі помилки.
    /// </summary>
    /// <param name="city">Назва міста.</param>
    private static async Task GetWeatherForCity(string city)
    {
        // Формуємо URL для запиту погоди, вказуючи місто, ключ API та одиниці виміру (метричні)
        string url = $"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={API_KEY}&units=metric&lang=ua";

        Console.WriteLine($"\nЗавантаження погоди для {city}...");

        try
        {
            // 1. Надсилання HTTP-запиту та перевірка статусу
            HttpResponseMessage response = await httpClient.GetAsync(url);

            // Обробка помилок HTTP (400, 500, та ін.)
            if (!response.IsSuccessStatusCode)
            {
                // Якщо помилка пов'язана з відсутністю міста (404 Not Found)
                if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                {
                    Console.ForegroundColor = ConsoleColor.Yellow;
                    Console.WriteLine($"[ПОМИЛКА]: Місто '{city}' не знайдено. Перевірте правильність написання.");
                }
                else
                {
                    // Інші помилки API або сервера
                    Console.ForegroundColor = ConsoleColor.Red;
                    Console.WriteLine($"[ПОМИЛКА API]: Запит завершився невдачею. Код статусу: {response.StatusCode}.");
                }
                Console.ResetColor();
                return;
            }

            // 2. Успішне отримання відповіді: десеріалізація JSON
            // Використовуємо ReadFromJsonAsync для прямої десеріалізації з потоку відповіді
            var weatherData = await response.Content.ReadFromJsonAsync<OpenWeatherResponse>();

            if (weatherData != null && weatherData.MainInfo != null && weatherData.Weather.Length > 0)
            {
                // 3. Виведення результату
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine("\n--- ✅ Результат ---");
                Console.WriteLine($"Місто: {weatherData.CityName}");
                Console.WriteLine($"Температура: {weatherData.MainInfo.Temperature:F1}°C");
                Console.WriteLine($"Відчувається як: {weatherData.MainInfo.FeelsLike:F1}°C");
                Console.WriteLine($"Опис: {weatherData.Weather[0].Description.Trim()}");
                Console.WriteLine($"Вологість: {weatherData.MainInfo.Humidity}%");
                Console.WriteLine("---------------------");
            }
            else
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Console.WriteLine("[ПОМИЛКА ОБРОБКИ]: Не вдалося розібрати дані або дані неповні.");
            }
        }
        // Обробка мережевих помилок (відсутність інтернету, таймаут, неможливість підключення до сервера)
        catch (HttpRequestException ex)
        {
            Console.ForegroundColor = ConsoleColor.Red;
            Console.WriteLine("\n[ПОМИЛКА МЕРЕЖІ]: Не вдалося підключитися до сервера OpenWeatherMap.");
            Console.WriteLine("Можливі причини: відсутнє інтернет-з'єднання, неправильний URL або проблема з DNS.");
            Console.WriteLine($"Деталі: {ex.Message}");
        }
        // Обробка інших можливих помилок (наприклад, помилки десеріалізації JSON)
        catch (Exception ex)
        {
            Console.ForegroundColor = ConsoleColor.Red;
            Console.WriteLine($"\n[НЕПЕРЕДБАЧЕНА ПОМИЛКА]: {ex.Message}");
        }
        finally
        {
            Console.ResetColor();
        }
    }
}